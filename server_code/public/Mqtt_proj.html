<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Weather Monitoring Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/vegas.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/templatemo-style.css">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #111;
            color: white;
        }

        #mqtt_logs {
            margin-top: 30px;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>

<body>

    <!-- HOME -->
    <section id="home">
        <div class="container">
            <div class="row">
                <div class="col-md-12 col-sm-12">
                    <div class="home-info text-center">
                        <h1><b>Weather <br>Observation Monitor </b></h1>
                        <ul class="countdown">
                            <li><span class="mqttlist_temp"></span>
                                <h3>온도</h3>
                            </li>
                            <li><span class="mqttlist_humi"></span>
                                <h3>습도</h3>
                            </li>
                            <li><span class="mqttlist_rainf"></span>
                                <h3>강수량</h3>
                            </li>
                            <li><span class="mqttlist_pre"></span>
                                <h3>강수형태</h3>
                            </li>
                        </ul>

                        <div id="mqtt_logs">
                            <button id="button1" onclick="button_on();" class="btn-on"><b>LED ON</b></button>
                            <button id="button2" onclick="button_off();" class="btn-off"><b>LED OFF</b></button>

                        </div>

                        <div id="weather-alert"
                            style="margin-top: 15px; font-weight: bold; font-size: 18px; color: rgb(0, 0, 0);">
                            현재 날씨 상태: <span id="weather-state"></span>
                        </div>



                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SCRIPTS -->
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/vegas.min.js"></script>
    <script src="js/countdown.js"></script>
    <script src="js/init.js"></script>
    <script src="js/custom.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script>
        var socket = io.connect();
        var timer = null;
        var ledOnState = false;
        var lastPreValue = "";

        $(document).ready(function () {
            // 서버에서 통합된 실시간 데이터를 받음
            socket.on("socket_evt_update", function (data) {
                data = JSON.parse(data);
                $(".mqttlist_temp").html(data.tmp + "℃");
                $(".mqttlist_humi").html(data.humi + "%");
                $(".mqttlist_rainf").html(data.rainf + " mm");
                $(".mqttlist_pre").html(PreType(data.pre));

                lastPreValue = data.pre;
                if (ledOnState) {
                    document.getElementById("weather-state").textContent = PreType(data.pre);
                }
            });

            // 주기적으로 최신 데이터 요청
            if (timer == null) {
                timer = window.setInterval(function () {
                    socket.emit("socket_evt_update", JSON.stringify({}));
                }, 3000);
            }
        });

        function button_on() {
            socket.emit("socket_evt_btn", "ON");
            ledOnState = true;
            const readable = PreType(lastPreValue);
            document.getElementById("weather-state").textContent = readable;
        }

        function button_off() {
            socket.emit("socket_evt_btn", "OFF");
            ledOnState = false;
            document.getElementById("weather-state").textContent = "";
        }

        function PreType(data) {                                                //공공 API에 기재되어있음. 코드 4는 (단기) 예보에만 존재. 
            if (data === undefined || data === null) return "정보 없음";        //강수형태(PTY) 코드 : (초단기) 없음(0), 비(1), 비/눈(2), 눈(3), 빗방울(5), 빗방울눈날림(6), 눈날림(7) 
            switch (String(data)) {
                case "0": return "강수 없음";
                case "1": return "비옴";
                case "2": return "비/눈";
                case "3": return "눈옴";
                case "5": return "빗방울";
                case "6": return "빗방울눈날림";
                case "7": return "눈날림";
                default: return "알 수 없음";
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #111;
            color: white;
            margin: 0;
            height: 100vh;
        }

        #home {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .home-info {
            background-color: rgba(255, 255, 255, 0.85);
            color: #000;
            padding: 20px 15px;
            border-radius: 12px;
            width: 320px;
            height: 600px;
            /* 고정 높이 */
            margin: 30px auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            overflow-y: auto;
            /* 내용 넘칠 때 세로 스크롤 */
            box-sizing: border-box;
        }

        .home-info,
        .home-info h1,
        .home-info h3,
        .home-info span {
            color: #000;
        }

        .btn-on {
            background-color: #55b97d;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
        }

        .btn-off {
            background-color: #e67267;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
        }

        .btn-on:hover,
        .btn-off:hover {
            opacity: 0.85;
            cursor: pointer;
        }
    </style>
</body>

</html>